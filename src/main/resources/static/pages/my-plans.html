<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的计划 - 智能学习计划生成器</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <style>
        .plan-card {
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        .plan-status {
            font-size: 0.85rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        .status-completed {
            background-color: #cce5ff;
            color: #004085;
        }
        .status-paused {
            background-color: #fff3cd;
            color: #856404;
        }
        .progress {
            height: 8px;
            border-radius: 4px;
        }
        .plan-detail-item {
            border-left: 3px solid #667eea;
            padding-left: 15px;
            margin-bottom: 15px;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        .empty-state i {
            font-size: 80px;
            color: #dee2e6;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="bi bi-book"></i> 智能学习计划生成器
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">仪表盘</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="create-plan.html">创建计划</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="my-plans.html">我的计划</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="ai-assistant.html">AI助手</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown" id="userMenu" style="display: none;">
                        <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> <span id="username">用户</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" onclick="logout()">退出登录</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" id="loginBtn">
                        <a class="nav-link" href="login.html">登录</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <!-- 页面标题 -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-journal-text"></i> 我的学习计划</h2>
            <a href="create-plan.html" class="btn btn-primary">
                <i class="bi bi-plus-lg"></i> 创建新计划
            </a>
        </div>

        <!-- 筛选和搜索 -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="搜索计划...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">所有状态</option>
                            <option value="进行中">进行中</option>
                            <option value="已完成">已完成</option>
                            <option value="已暂停">已暂停</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="sortBy">
                            <option value="newest">最新创建</option>
                            <option value="oldest">最早创建</option>
                            <option value="progress">按进度</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" onclick="filterPlans()">
                            <i class="bi bi-funnel"></i> 筛选
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 未登录提示 -->
        <div class="alert alert-warning" id="loginAlert" style="display: none;">
            <i class="bi bi-exclamation-triangle"></i> 
            请先 <a href="login.html">登录</a> 或 <a href="register.html">注册</a> 以查看您的学习计划。
        </div>

        <!-- 计划列表 -->
        <div id="plansList">
            <!-- 空状态 -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="bi bi-journal-x"></i>
                <h4>还没有学习计划</h4>
                <p class="text-muted">创建您的第一个智能学习计划，让AI帮您规划学习路径</p>
                <a href="create-plan.html" class="btn btn-primary btn-lg mt-3">
                    <i class="bi bi-plus-lg"></i> 创建计划
                </a>
            </div>

            <!-- 计划卡片容器 -->
            <div class="row" id="plansContainer">
                <!-- 动态加载计划卡片 -->
            </div>
        </div>

        <!-- 加载状态 -->
        <div class="text-center py-5" id="loadingState">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2 text-muted">正在加载您的计划...</p>
        </div>
    </div>

    <!-- 计划详情模态框 -->
    <div class="modal fade" id="planDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalPlanTitle">计划详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="modalPlanContent">
                    <!-- 动态加载计划详情 -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-danger" onclick="deletePlan()">
                        <i class="bi bi-trash"></i> 删除计划
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/common.js"></script>
    <script>
        let currentPlans = [];
        let selectedPlanId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // 使用统一的登录状态检查
            await initLoginStatus();
            onLoginStatusReady();
        });

        // 监听登录状态变化
        window.addEventListener('loginStatusChanged', function(e) {
            onLoginStatusReady();
        });

        function onLoginStatusReady() {
            if (isLoggedIn()) {
                document.getElementById('loginAlert').style.display = 'none';
                loadPlans();
            } else {
                document.getElementById('loginAlert').style.display = 'block';
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        async function loadPlans() {
            if (!isLoggedIn()) {
                document.getElementById('loadingState').style.display = 'none';
                return;
            }

            try {
                const result = await apiRequest('/plan/my-plans');

                document.getElementById('loadingState').style.display = 'none';

                if (result && result.code === 200) {
                    currentPlans = result.data || [];
                    renderPlans(currentPlans);
                } else if (result) {
                    showToast('加载失败: ' + result.message, 'error');
                }
            } catch (error) {
                document.getElementById('loadingState').style.display = 'none';
                showToast('网络错误: ' + error.message, 'error');
            }
        }

        function renderPlans(plans) {
            const container = document.getElementById('plansContainer');
            const emptyState = document.getElementById('emptyState');

            if (!plans || plans.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            container.innerHTML = plans.map(plan => createPlanCard(plan)).join('');
        }

        function createPlanCard(plan) {
            const statusClass = getStatusClass(plan.status);
            const statusText = getStatusText(plan.status);
            const progress = plan.progress || 0;
            const createdDate = new Date(plan.createTime).toLocaleDateString('zh-CN');

            return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card plan-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${escapeHtml(plan.subject)}</h5>
                                <span class="plan-status ${statusClass}">${statusText}</span>
                            </div>
                            <p class="card-text text-muted small">
                                <i class="bi bi-calendar"></i> ${createdDate}
                                <span class="ms-2"><i class="bi bi-clock"></i> ${plan.duration || 0}天</span>
                            </p>
                            <div class="mb-3">
                                <div class="d-flex justify-content-between small mb-1">
                                    <span>学习进度</span>
                                    <span>${progress}%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            <p class="card-text small">${escapeHtml(truncateText(plan.goal || '暂无目标描述', 80))}</p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="viewPlanDetail(${plan.id})">
                                <i class="bi bi-eye"></i> 查看详情
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="continueLearning(${plan.id})">
                                <i class="bi bi-play"></i> 继续学习
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function normalizeStatusValue(status) {
            if (!status) return '';
            const map = {
                'active': '进行中',
                'completed': '已完成',
                'paused': '已暂停'
            };
            return map[status] || status;
        }

        function getStatusClass(status) {
            const normalized = normalizeStatusValue(status);
            switch(normalized) {
                case '进行中': return 'status-active';
                case '已完成': return 'status-completed';
                case '已暂停': return 'status-paused';
                default: return 'status-active';
            }
        }

        function getStatusText(status) {
            const normalized = normalizeStatusValue(status);
            switch(normalized) {
                case '进行中': return '进行中';
                case '已完成': return '已完成';
                case '已暂停': return '已暂停';
                default: return '进行中';
            }
        }

        async function viewPlanDetail(planId) {
            selectedPlanId = planId;
            
            try {
                const result = await apiRequest(`/plan/${planId}`);

                if (result && result.code === 200) {
                    showPlanDetail(result.data);
                } else if (result) {
                    showToast('获取详情失败: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('获取详情失败: ' + error.message, 'error');
            }
        }

        function showPlanDetail(data) {
            const plan = data.plan || data;
            document.getElementById('modalPlanTitle').textContent = plan.subject || plan.goal;
            
            let detailsHtml = `
                <div class="mb-4">
                    <h6><i class="bi bi-bullseye"></i> 学习目标</h6>
                    <p>${escapeHtml(plan.goal || '暂无')}</p>
                </div>
                <div class="mb-4">
                    <h6><i class="bi bi-clock-history"></i> 计划时长</h6>
                    <p>${plan.duration || plan.totalDays || 0} 天</p>
                </div>
                <div class="mb-4">
                    <h6><i class="bi bi-bar-chart"></i> 当前进度</h6>
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar" style="width: ${data.progress || plan.progress || 0}%">${data.progress || plan.progress || 0}%</div>
                    </div>
                </div>
            `;

            const details = data.details || plan.details || [];
            if (details.length > 0) {
                detailsHtml += `<h6><i class="bi bi-list-check"></i> 学习内容</h6>`;
                details.forEach((detail, index) => {
                    detailsHtml += `
                        <div class="plan-detail-item">
                            <strong>第${index + 1}阶段: ${escapeHtml(detail.title || detail.dayNumber ? '第' + detail.dayNumber + '天' : '')}</strong>
                            <p class="mb-1 small text-muted">${escapeHtml(detail.content || '')}</p>
                        </div>
                    `;
                });
            }

            document.getElementById('modalPlanContent').innerHTML = detailsHtml;
            new bootstrap.Modal(document.getElementById('planDetailModal')).show();
        }

        async function deletePlan() {
            if (!selectedPlanId) return;
            
            if (!confirm('确定要删除这个计划吗？此操作不可撤销。')) {
                return;
            }

            try {
                const result = await apiRequest(`/plan/${selectedPlanId}`, {
                    method: 'DELETE'
                });

                if (result && result.code === 200) {
                    bootstrap.Modal.getInstance(document.getElementById('planDetailModal')).hide();
                    loadPlans();
                    showToast('计划已删除', 'success');
                } else if (result) {
                    showToast('删除失败: ' + result.message, 'error');
                }
            } catch (error) {
                showToast('删除失败: ' + error.message, 'error');
            }
        }

        function continueLearning(planId) {
            window.location.href = `dashboard.html?planId=${planId}`;
        }

        function filterPlans() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            let filtered = [...currentPlans];

            // 搜索过滤
            if (searchText) {
                filtered = filtered.filter(plan => 
                    (plan.subject && plan.subject.toLowerCase().includes(searchText)) ||
                    (plan.goal && plan.goal.toLowerCase().includes(searchText))
                );
            }

            // 状态过滤
            if (statusFilter) {
                filtered = filtered.filter(plan => normalizeStatusValue(plan.status) === statusFilter);
            }

            // 排序
            switch(sortBy) {
                case 'newest':
                    filtered.sort((a, b) => new Date(b.createTime) - new Date(a.createTime));
                    break;
                case 'oldest':
                    filtered.sort((a, b) => new Date(a.createTime) - new Date(b.createTime));
                    break;
                case 'progress':
                    filtered.sort((a, b) => (b.progress || 0) - (a.progress || 0));
                    break;
            }

            renderPlans(filtered);
        }
        // escapeHtml 和 truncateText 已在 common.js 中定义
    </script>
</body>
</html>
